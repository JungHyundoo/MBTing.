<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="kakaoPayMapper">

 <resultMap id="kakaoPayResultSet" type="KakaoPay">
 	<result column="PARTNER_ORDER_ID"  	property="partnerOrderId"></result>
 	<result column="TID"  				property="tid"></result>
 	<result column="CID"  				property="cid"></result>
 	<result column="PARTNER_USER_ID" 	property="partnerUserId"></result>
 	<result column="ITEM_NAME"  		property="itemName"></result>
 	<result column="PAY_METHOD"  		property="payMethod"></result>
 	<result column="QUANTITY"  			property="quantity"></result>
 	<result column="ORDER_DATE" 	 	property="orderDate"></result>
 	<result column="REFUND_DATE"  		property="refundDate"></result>
 	<result column="TOTAL_AMOUNT"  		property="totalAmount"></result>
 	<result column="TAX_FREE_AMOUNT"  	property="taxFreeAmount"></result>
 	<result column="PG_TOKEN"			property="pg_token"></result>
 </resultMap>
 
 <insert id="insertPay" parameterType="KakaoPay">
 	INSERT INTO KAKAOPAY (PARTNER_ORDER_ID,PARTNER_USER_ID,ITEM_NAME,PAY_METHOD,QUANTITY,TOTAL_AMOUNT,TAX_FREE_AMOUNT)
 	 	 VALUES (ORD_SEQ.NEXTVAL,
 	 	 		 #{partnerUserId},
 	 	 		 #{itemName},
 	 	 		 '카카오페이',
 	 	 		 #{quantity},
 	 	 		 #{totalAmount},
 	 	 		 #{taxFreeAmount})
 </insert>
 
 <select id="getPartnerOrder" parameterType="string" resultType="string">
 	SELECT PARTNER_ORDER_ID
 	  FROM (
 	  	SELECT PARTNER_ORDER_ID
 	  	  FROM KAKAOPAY
 	 	 WHERE PARTNER_USER_ID = #{email}
 	 	 ORDER BY PARTNER_ORDER_ID DESC)
 	 WHERE ROWNUM = 1
 </select>
 
 <update id="insertTid" parameterType="KakaoPay">
 	 UPDATE KAKAOPAY
 	    SET TID = #{tid}
 	 WHERE PARTNER_ORDER_ID = #{partnerOrderId}
 	   AND PARTNER_USER_ID = #{partnerUserId}
 
 </update>
 
 <update id="insertPgToken" parameterType="KakaoPay">
 	UPDATE KAKAOPAY
 	   SET PG_TOKEN = #{pg_token}
 	 WHERE PARTNER_ORDER_ID = #{partnerOrderId}
 </update>

<!-- 내 결제 리스트 수 조회용 쿼리문 -->
<select id="selectOrderListCount" parameterType="string" resultType="_int">
		SELECT COUNT(*)
	  	  FROM KAKAOPAY
	 	 WHERE PARTNER_USER_ID = #{email}
	 	   AND PG_TOKEN IS NOT NULL
</select>

<!-- 내 결제 리스트 조회용 쿼리문 -->
<select id="orderList" parameterType="string" resultMap="kakaoPayResultSet">
	
        SELECT *
		  FROM KAKAOPAY
		 WHERE PARTNER_USER_ID = #{email}
		   AND PG_TOKEN IS NOT NULL
		 ORDER BY PARTNER_ORDER_ID DESC

</select>
	
<!-- 관리자페이지 전체 결제 금액 -->
<select id="selectTotalPay" resultType="_int">
	SELECT SUM(TOTAL_AMOUNT)
      FROM KAKAOPAY
</select>

<!-- 관리자페이지 유료계정비율 원그래프 -->
<select id="totalPremiumCount" resultType="_int">
	SELECT SUM(A) AS PREMIUM_COUNT
	  FROM (SELECT COUNT(*) A 
	          FROM KAKAOPAY
	         WHERE PG_TOKEN IS NOT NULL
	         GROUP BY PARTNER_USER_ID) 
</select>

<!-- 관리자페이지 무료계정비율 원그래프 -->
<select id="totalFreeCount" resultType="_int">
	WITH MemberCount AS (
  SELECT COUNT(EMAIL) AS M
  FROM MEMBER
),
KakaoPayCount AS (
  SELECT SUM(A) AS M
  FROM (
    SELECT COUNT(*) AS A
    FROM KAKAOPAY
    WHERE PG_TOKEN IS NOT NULL
    GROUP BY PARTNER_USER_ID
  )
)
SELECT MemberCount.M - KakaoPayCount.M AS Result
FROM MemberCount, KakaoPayCount
</select>


<!-- 관리자페이지 월 별 매출 그래프 -->
<select id="totalMonthlySalesCount" resultType="_int">
	WITH Months AS (
    SELECT TO_CHAR(ADD_MONTHS(TRUNC(SYSDATE, 'YYYY'), LEVEL - 1), 'MM') AS month
    FROM dual
    CONNECT BY LEVEL &lt;= 12
	)
	SELECT NVL(SUM(kakaopay.TOTAL_AMOUNT), 0) AS TOTAL_AMOUNT
	  FROM Months m
	  LEFT JOIN kakaopay ON TO_CHAR(kakaopay.ORDER_DATE, 'MM') = m.month
	 WHERE EXTRACT(YEAR FROM kakaopay.ORDER_DATE) = EXTRACT(YEAR FROM SYSDATE)
	 GROUP BY m.month
	 ORDER BY m.month
</select>

<!-- 관리자페이지 년 별 매출 그래프 -->
<select id="totalyearlySalesCount" resultType="_int">
	SELECT NVL(SUM(kakaopay.TOTAL_AMOUNT), 0) AS TOTAL_AMOUNT
	FROM kakaopay
	WHERE TO_CHAR(kakaopay.ORDER_DATE, 'YYYY') BETWEEN '2019' AND TO_CHAR(SYSDATE, 'YYYY')
	GROUP BY TO_CHAR(kakaopay.ORDER_DATE, 'YYYY')
	ORDER BY TO_CHAR(kakaopay.ORDER_DATE, 'YYYY')
</select>
</mapper>